install.packages('devtools') # only needed if devtools is not currently installed
devtools::install_github('StrattonCh/msocc')
devtools::install_github('StrattonCh/msocc')
remove.packages("conflicted", lib="~/R/win-library/4.0")
#===============Delta Base Layer================================
marsh <- st_read(
"CODE-spatial-analysis/hydro-delta-marsh/hydro_delta_marsh.shp")
theme_set(theme_bw())
library("sf")
library("tidyverse")
library("rnaturalearth")
library("rnaturalearthdata")
library("rnaturalearthhires")
library("stringr")
library("RColorBrewer")
library("spatialEco")
library(geosphere)
select <- dplyr::select
filter <- dplyr::filter
#===============Delta Base Layer================================
marsh <- st_read(
"CODE-spatial-analysis/hydro-delta-marsh/hydro_delta_marsh.shp")
setwd("C:/Users/40545/Documents/GitHub/pelagicsurveys")
#===============Delta Base Layer================================
marsh <- st_read(
"CODE-spatial-analysis/hydro-delta-marsh/hydro_delta_marsh.shp")
EDSM_Strata <- st_read(
"CODE-spatial-analysis/DSm_Subregions_UTM10NAD83/DSm_Subregions_UTM10NAD83.shp")
Adjacent <- read_csv("SpatialData/Adjacent_Strata.csv")%>%mutate_all(as.factor)
load("FINAL_REVIEW_DATA/CDFW_Pelagic_Review_Data.rda")
StartEnd <- read_csv("SpatialData/TowStartEndPositions.csv")%>%
mutate_at(c("StationCode","SurveySeason"),as.factor)%>%
pivot_wider(names_from = "Type",values_from=(c("Longitude","Latitude")))
StartEnd_SF <- StartEnd %>%
st_as_sf( coords = c("Longitude", "Latitude"),
crs = 4326, agr = "constant")
FieldDistances <- StartEnd %>%
mutate(TowDist = pmap_dbl(., ~
distm(x = c(..10, ..13), y = c(..11, ..14), fun = distHaversine))/1000,
DistToStation_Start = pmap_dbl(., ~
distm(x = c(..10, ..13), y = c(..12, ..15), fun = distHaversine))/1000,
DistToStation_End = pmap_dbl(., ~
distm(x = c(..11, ..14), y = c(..12, ..15), fun = distHaversine))/1000
)%>%
filter(DistToStation_Start<3)%>%
filter((TowDist<3) %>% replace_na(TRUE))%>%
filter((DistToStation_End<3) %>% replace_na(TRUE))%>%
group_by(SurveySeason)%>%
mutate(Station_Mean_Towdist = mean(TowDist,na.rm=T),
Station_Mean_StartDist = mean(DistToStation_Start,na.rm=T),
Station_Mean_EndDist = mean(DistToStation_End,na.rm=T))%>%
ungroup()
FieldDistances %>%
group_by(StationCode,SurveySeason)%>%
mutate(N_Tows = n())%>%
ungroup()%>%
ggplot(aes(x=DistToStation_Start,y=StationCode))+
geom_boxplot()+facet_grid(~SurveySeason,scales="free_y",space="free_y")+
geom_vline(aes(xintercept = Station_Mean_StartDist))+
#scale_fill_viridis_c()+
#scale_color_viridis_c()+
xlab("Distance between tow start and station coordinates (km)")+
ggtitle("Tow start distance from station (km)")
Adjacent_Regions <- Adjacent%>%filter(Group_Level=="Region")%>%select(-Group_Level)%>%rename("Review_Region" = "Region")%>%
mutate(Review_Region = droplevels(Review_Region))
Adjacent_Strata <- Adjacent%>% filter(Group_Level=="Stratum")%>%select(-Group_Level)%>%rename("Review_Stratum" = "Region")%>%
mutate(Review_Stratum = droplevels(Review_Stratum))
tmat.g1 <- Review_Data_By_Station%>%full_join(Adjacent_Strata,by="Review_Stratum")%>%
filter(Adjacent_Grouping=="Group1")%>%
filter_at(vars(contains("CPUV")), any_vars(. != 0))
PMN1 <- adonis2(tmat.g1[,19:42]~tmat.g1$Review_Stratum*tmat.g1$SurveySeason)
tmat.g1 %>% ggplot(aes(x=Review_Stratum,color=SurveySeason)) +
stat_summary(aes(y = CPUV_Delta_Smelt_Age_0),
fun.y = mean, na.rm = TRUE,
geom = "bar",
size = 3) +
stat_summary(aes(y = CPUV_Delta_Smelt_Age_0),
fun.data = mean_se, na.rm = TRUE,
geom = "errorbar",
width = 0.2)
tmat.g1 %>% ggplot(aes(x=Review_Stratum,color=SurveySeason)) +
stat_summary(aes(y = CPUV_Delta_Smelt_Age_0),
fun.y = mean, na.rm = TRUE,
geom = "bar",
size = 3,
position="dodge") +
stat_summary(aes(y = CPUV_Delta_Smelt_Age_0),
fun.data = mean_se, na.rm = TRUE,
geom = "errorbar",
width = 0.2)
tmat.g1 %>% ggplot(aes(x=Review_Stratum,color=SurveySeason)) +
stat_summary(aes(y = CPUV_Delta_Smelt_Age_0),
fun.y = mean, na.rm = TRUE,
geom = "bar",
size = 3,
position="dodge") +
stat_summary(aes(y = CPUV_Delta_Smelt_Age_0),
fun.data = mean_se, na.rm = TRUE,
geom = "errorbar",
width = 0.2,position="dodge")
tmat.g1 %>% ggplot(aes(x=Review_Stratum,color=SurveySeason)) +
stat_summary(aes(y = CPUV_Delta_Smelt_Age_0),
fun = mean, na.rm = TRUE,
geom = "bar",
size = 3,
position="dodge") +
stat_summary(aes(y = CPUV_Delta_Smelt_Age_0),
fun.data = mean_se, na.rm = TRUE,
geom = "errorbar",
width = 0.2,
position="dodge")
tmat.g1 %>% ggplot(aes(x=Review_Stratum,fill=SurveySeason)) +
stat_summary(aes(y = CPUV_Delta_Smelt_Age_0),
fun = mean, na.rm = TRUE,
geom = "bar",
size = 3,
position="dodge") +
stat_summary(aes(y = CPUV_Delta_Smelt_Age_0),
fun.data = mean_se,
na.rm = TRUE,
geom = "errorbar",
width = 0.2,
position="dodge")
tmat.g1 %>% ggplot(aes(x=Review_Stratum,fill=SurveySeason)) +
stat_summary(aes(y = CPUV_Delta_Smelt_Age_0),
fun = mean, na.rm = TRUE,
geom = "bar",
size = 3,
position="dodge") +
stat_summary(aes(y = CPUV_Delta_Smelt_Age_0),
fun = mean_se,
na.rm = TRUE,
geom = "errorbar",
width = 0.2,
position="dodge")
tmat.g1 %>% group_by(SurveySeason,Review_Stratum)%>%
summarise(DeltaSmelt = mean(CPUV_Delta_Smelt_Age_0),
stdv = sd(CPUV_Delta_Smelt_Age_0))%>%
ggplot(aes(x=Review_Stratum,fill=SurveySeason,y=DeltaSmelt))+geom_bar(stat="identity")
tmat.g1 %>% group_by(SurveySeason,Review_Stratum)%>%
summarise(DeltaSmelt = mean(CPUV_Delta_Smelt_Age_0),
stdv = sd(CPUV_Delta_Smelt_Age_0))%>%
ggplot(aes(x=Review_Stratum,fill=SurveySeason,y=DeltaSmelt))+geom_bar(stat="identity",position="dodge")
tmat.g1 %>% group_by(SurveySeason,Review_Stratum)%>%
summarise(DeltaSmelt = mean(CPUV_Delta_Smelt_Age_0),
stdv = sd(CPUV_Delta_Smelt_Age_0))%>%
ggplot(aes(x=Review_Stratum,fill=SurveySeason,y=DeltaSmelt))+
geom_bar(stat="identity",position="dodge")+
geom_errorbar(aes(ymin=DeltaSmelt-stdv, ymax=DeltaSmelt+stdv), width=.2,
position=position_dodge(.9))
Review_Data_Tows %>%
group_by(SurveySeason,Review_Stratum,Year,Month)%>%
c(0,1,0)==T
Review_Data_Tows %>%
group_by(SurveySeason,Review_Stratum,Year,Month)%>%
c(0,1,0)==T
c(0,1,0)==T
Review_Data_Tows %>%
group_by(SurveySeason,Review_Stratum,Year,Month)%>%
sum(c(0,1,0)==T)
sum(c(0,1,0)==T)
sum(c(0,1,1)==T)
Prop0 <- function(x){sum(x==0)/length(x)}
Review_Data_Tows %>%
group_by(SurveySeason,Review_Stratum,Year,Month)%>%
Prop0(c(0,1,0))
Prop0(c(0,1,0))
Review_Data_Tows %>%
group_by(SurveySeason,Review_Stratum,Year,Month)%>%
summarize_at(vars(contains("CPUV")),Prop0)
Review_Data_Tows %>%
group_by(SurveySeason,Review_Stratum,Year,Month)%>%
mutate(N_Tows = n())%>%
group_by(SurveySeason,Review_Stratum,Year,Month,N_Tows)%>%
summarize_at(vars(contains("CPUV")),Prop0))
Review_Data_Tows %>%
group_by(SurveySeason,Review_Stratum,Year,Month)%>%
mutate(N_Tows = n())%>%
group_by(SurveySeason,Review_Stratum,Year,Month,N_Tows)%>%
summarize_at(vars(contains("CPUV")),Prop0))
Review_Data_Tows %>%
group_by(SurveySeason,Review_Stratum,Year,Month)%>%
mutate(N_Tows = n())%>%
group_by(SurveySeason,Review_Stratum,Year,Month,N_Tows)%>%
summarize_at(vars(contains("CPUV")),Prop0)
Review_Data_Tows %>%
group_by(SurveySeason,Review_Stratum,Year,Month)%>%
mutate(N_Tows = n())%>%
group_by(SurveySeason,Review_Stratum,Year,Month,N_Tows)%>%
summarize_at(vars(contains("CPUV")),Prop0)%>%view()
DetectionData <- Review_Data_Tows %>%
group_by(SurveySeason,Review_Stratum,Year,Month)%>%
mutate(N_Tows = n())%>%
group_by(SurveySeason,Review_Stratum,Year,Month,N_Tows)%>%
summarize_at(vars(contains("CPUV")),Prop0)%>%view()
DetectionData <- Review_Data_Tows %>%
group_by(SurveySeason,Review_Stratum,Year,Month)%>%
mutate(N_Tows = n())%>%
group_by(SurveySeason,Review_Stratum,Year,Month,N_Tows)%>%
summarize_at(vars(contains("CPUV")),Prop0)
table(DetectionData$N_Tows<5)
table(DetectionData$N_Tows<5,DetectionData$SurveySeason)
table(DetectionData$N_Tows<3,DetectionData$SurveySeason)
View(DetectionData)
Prop0 <- function(x){sum(x!=0)/length(x)}
DetectionData <- Review_Data_Tows %>%
group_by(SurveySeason,Review_Stratum,Year,Month)%>%
mutate(N_Tows = n())%>%
group_by(SurveySeason,Review_Stratum,Year,Month,N_Tows)%>%
summarize_at(vars(contains("CPUV")),Prop0)
View(DetectionData)
names(DetectionData) %>% str_split()
names(DetectionData) %>% str_split(pattern="_")
names(DetectionData) %>% str_split(pattern="CPUV_")
names(DetectionData) %>% str_split(pattern="CPUV_")%>%data.frame()
names(DetectionData) %>% sapply(strsplit(names(df), "_3"), `[[`, 1)
sapply(strsplit(names(DetectionData), "CPUV_"), `[[`, 1)
sapply(strsplit(names(DetectionData), "CPUV_"), `[[`, 2)
gsub("CPUV_","",colnames(DetectionData))
names(DetectionData) <- gsub("CPUV_","",colnames(DetectionData))
DetectionData %>% filter(N_Tows>2)%>%
ggplot(aes(x=Year,Y=American_Shad_Age_0))
DetectionData %>% filter(N_Tows>2)%>%
ggplot(aes(x=Year,Y=American_Shad_Age_0))+
facet_grid(cols=vars(Month),rows=vars(Review_Region))
DetectionData %>% filter(N_Tows>2)%>%
ggplot(aes(x=Year,Y=American_Shad_Age_0))+
facet_grid(cols=vars(Month),rows=vars(Review_Stratum))
DetectionData %>% filter(N_Tows>2)%>%
ggplot(aes(x=Year,Y=American_Shad_Age_0))+
facet_grid(rows=vars(Month),cols=vars(Review_Stratum))
DetectionData %>% filter(N_Tows>2)%>%
ggplot(aes(x=Year,Y=American_Shad_Age_0,col=SurveySeason))+
facet_grid(rows=vars(Month),cols=vars(Review_Stratum),scales="free_y")+geom_line()
DetectionData %>% filter(N_Tows>2)%>%
ggplot(aes(x=Year,Y=American_Shad_Age_0,col=SurveySeason))+geom_line()+
facet_grid(rows=vars(Month),cols=vars(Review_Stratum),scales="free_y")
DetectionData %>% filter(N_Tows>2)%>%
ggplot(aes(x=Year,Y=American_Shad_Age_0,col=SurveySeason))+geom_line()+
facet_grid(rows=vars(Month),cols=vars(Review_Stratum),scales="free_y")
DetectionData %>% filter(N_Tows>2)%>%
ggplot(aes(x=Year,y=American_Shad_Age_0,col=SurveySeason))+geom_line()+
facet_grid(rows=vars(Month),cols=vars(Review_Stratum),scales="free_y")
DetectionData %>% filter(N_Tows>2)%>%
ggplot(aes(x=Year,y=American_Shad_Age_0,col=SurveySeason))+geom_line()+
facet_grid(rows=vars(Month),cols=vars(Review_Stratum))
DetectionData %>% filter(N_Tows>2)%>%
ggplot(aes(x=Year,y=Delta_Smelt_Age_0,col=SurveySeason))+geom_line()+
facet_grid(rows=vars(Month),cols=vars(Review_Stratum))
DetectionData %>% filter(N_Tows>2)%>%
ggplot(aes(x=Year,y=Pacific_Herring_Age_0,col=SurveySeason))+geom_line()+
facet_grid(rows=vars(Month),cols=vars(Review_Stratum))
plot_detections <- function(taxa){
Data <- DetectionData %>% select(Year,Month,Review_Stratum,SurveySeason,taxa)
names(Data)[5] <- "Encounter_Proportion"
print(head(Data))
}
plot_detections("Delta_Smelt_Age_0")
plot_detections <- function(taxa){
Data <- DetectionData %>% select(Year,Month,Review_Stratum,SurveySeason,taxa)
names(Data)[5] <- "Encounter_Proportion"
plot_detections("Delta_Smelt_Age_0")
Data %>% filter(N_Tows>2)%>%
ggplot(aes(x=Year,y=Pacific_Herring_Age_0,col=SurveySeason))+geom_line()+
facet_grid(rows=vars(Month),cols=vars(Review_Stratum))%>%print()
}
plot_detections <- function(taxa){
Data <- DetectionData %>% select(Year,Month,Review_Stratum,SurveySeason,taxa)
names(Data)[5] <- `Encounter_Proportion`
plot_detections("Delta_Smelt_Age_0")
Data %>% filter(N_Tows>2)%>%
ggplot(aes(x=Year,y=`Encounter_Proportion`,col=SurveySeason))+geom_line()+
facet_grid(rows=vars(Month),cols=vars(Review_Stratum))%>%print()
}
plot_detections <- function(taxa){
Data <- DetectionData %>% select(Year,Month,Review_Stratum,SurveySeason,taxa)
names(Data)[5] <- `Encounter_Proportion`
Data %>% filter(N_Tows>2)%>%
ggplot(aes(x=Year,y=`Encounter_Proportion`,col=SurveySeason))+geom_line()+
facet_grid(rows=vars(Month),cols=vars(Review_Stratum))%>%print()
}
plot_detections("Delta_Smelt_Age_0")
plot_detections <- function(taxa){
Data <- DetectionData %>% select(Year,Month,Review_Stratum,SurveySeason,taxa)
names(Data)[5] <- `Encounter_Proportion`
Data %>% filter(N_Tows>2)%>%
ggplot(aes(x=Year,y=`Encounter Proportion`,col=SurveySeason))+geom_line()+
facet_grid(rows=vars(Month),cols=vars(Review_Stratum))%>%print()
}
plot_detections("Delta_Smelt_Age_0")
plot_detections <- function(taxa){
Data <- DetectionData %>% select(Year,Month,Review_Stratum,SurveySeason,taxa)
names(Data)[5] <- "Encounter Proportion"
Data %>% filter(N_Tows>2)%>%
ggplot(aes(x=Year,y=`Encounter Proportion`,col=SurveySeason))+geom_line()+
facet_grid(rows=vars(Month),cols=vars(Review_Stratum))%>%print()
}
plot_detections("Delta_Smelt_Age_0")
plot_detections <- function(taxa){
Data <- DetectionData %>% select(Year,Month,Review_Stratum,SurveySeason,taxa,N_Tows)
names(Data)[5] <- "Encounter Proportion"
Data %>% filter(N_Tows>2)%>%
ggplot(aes(x=Year,y=`Encounter Proportion`,col=SurveySeason))+geom_line()+
facet_grid(rows=vars(Month),cols=vars(Review_Stratum))%>%print()
}
plot_detections("Delta_Smelt_Age_0")
plot_detections <- function(taxa){
Data <- DetectionData %>% select(Year,Month,Review_Stratum,SurveySeason,taxa,N_Tows)
names(Data)[5] <- "Encounter Proportion"
Data %>% filter(N_Tows>2)%>%
ggplot(aes(x=Year,y=`Encounter Proportion`,col=SurveySeason))+geom_line()+
facet_grid(rows=vars(Month),cols=vars(Review_Stratum))
}
plot_detections("Delta_Smelt_Age_0")
plot_detections("Delta_Smelt_Age_1")
levels(DetectionData$Review_Stratum)
DetectionData <- Review_Data_Tows %>%
group_by(SurveySeason,Review_Stratum,Year,Month)%>%
mutate(N_Tows = n())%>%
group_by(SurveySeason,Review_Stratum,Year,Month,N_Tows)%>%
summarize_at(vars(contains("CPUV")),Prop0)%>%
mutate(Review_Stratum = factor(Review_Stratum,
levels=c("San Pablo Bay and Carquinez Strait",
"Napa River",
"Suisun and Honker Bays",
"Suisun Marsh",
"Confluence",
"Cache Slough",
"South",
"North and South Forks Mokelumne River",
"Sacramento Mainstem",
"Sacramento Ship Channel")))
names(DetectionData) <- gsub("CPUV_","",colnames(DetectionData))
DetectionData %>% filter(N_Tows>2)%>%
ggplot(aes(x=Year,y=American_Shad_Age_0,col=SurveySeason))+geom_line()+
facet_grid(rows=vars(Month),cols=vars(Review_Stratum))
DetectionData <- Review_Data_Tows %>%
group_by(SurveySeason,Review_Stratum,Year,Month)%>%
mutate(N_Tows = n())%>%
group_by(SurveySeason,Review_Stratum,Year,Month,N_Tows)%>%
summarize_at(vars(contains("CPUV")),Prop0)%>%
mutate(Review_Stratum = factor(Review_Stratum,
levels=c("San Pablo Bay and Carquinez Strait",
"Napa River*",
"Suisun and Honker Bays",
"Suisun Marsh",
"Confluence",
"Cache Slough",
"South",
"North and South Forks Mokelumne River",
"Sacramento Mainstem",
"Sacramento Ship Channel")))
names(DetectionData) <- gsub("CPUV_","",colnames(DetectionData))
DetectionData %>% filter(N_Tows>2)%>%
ggplot(aes(x=Year,y=American_Shad_Age_0,col=SurveySeason))+geom_line()+
facet_grid(rows=vars(Month),cols=vars(Review_Stratum))
colMeans(DetectionData)
plot_detections("White_Sturgeon_Age_0")
plot_detections("Tridentiger_Spp._Age_0")
